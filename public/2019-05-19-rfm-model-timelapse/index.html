<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <meta name="generator" content="Hugo 0.64.0" />

  
  <meta name="description" content="Applied data science breadcrumbs">
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="https://notsoformal.xyz/apple-touch-icon.png">

  
  <link rel="icon" type="image/png" sizes="32x32" href="https://notsoformal.xyz/favicon-32x32.png">

  
  <link rel="icon" type="image/png" sizes="16x16" href="https://notsoformal.xyz/favicon-16x16.png">

  
  <link rel="manifest" href="https://notsoformal.xyz/site.webmanifest">

  
  <link rel="mask-icon" href="https://notsoformal.xyz/safari-pinned-tab.svg" color="#5bbad5">

  <meta name="msapplication-TileColor" content="#da532c">

  <meta name="theme-color" content="#ffffff">

  
  <link rel="stylesheet" href="https://notsoformal.xyz/css/bootstrap.min.css" />

  <link rel="stylesheet" href="https://notsoformal.xyz/css/xcode.css" rel="stylesheet" id="theme-stylesheet">
  <script src="https://notsoformal.xyz/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  
  <title>RFM Model Timelapse | Not So Formal</title>
  

  <style>
 
@font-face {
    font-family: 'PT Sans';
    font-style: normal;
    font-weight: 400;
    src: url('../fonts/pt-sans-v11-latin-regular.eot');  
    src: local('PT Sans'), local('PTSans-Regular'),
         url('../fonts/pt-sans-v11-latin-regular.eot?#iefix') format('embedded-opentype'),  
         url('../fonts/pt-sans-v11-latin-regular.woff2') format('woff2'),  
         url('../fonts/pt-sans-v11-latin-regular.woff') format('woff'),  
         url('../fonts/pt-sans-v11-latin-regular.ttf') format('truetype'),  
         url('../fonts/pt-sans-v11-latin-regular.svg#PTSans') format('svg');  
  }

small a {
    opacity: 0.5;
    color: #000;
}

body {
  min-width: 300px;
  font-family: "PT Sans"
}

.custom-navbar {
  margin-bottom: 1em;
  height: 60px;
}

.custom-navbar a {
  display: inline-block;
  padding: 18px 0;
  margin-right: 1em;
  font-weight: bold;
}

.custom-navbar a:hover,
.custom-navbar a:focus {
  text-decoration: none;
}

@media print {
  .custom-navbar {
    display: none;
  }
}

article {
  padding-bottom: 1em;
}

img {
  max-width: 100%;
}


body {
  background-color: #ffffff;
}



body {
  color: #000;
}



a {
  color: #E71D36;
}



a:hover,
a:focus {
  color: #FF9F1C;
}



.custom-navbar {
  background-color: #212529;
}



.custom-navbar a {
  color: #FFF;
}



.custom-navbar a:hover,
.custom-navbar a:focus {
  color: #FF9F1C;
}



.container {
  max-width: 800px;
}



pre {
  display: block;
  padding: 1px;
  word-break: break-all;
  word-wrap: break-word;
  background-color: #E2E2E2;
   
  border-radius: 4px;
  box-shadow: 5px 5px 5px grey;
}

pre code {
  padding: 0;
  font-size: 1em;
  color: inherit;
  white-space: pre-wrap;
  background-color: transparent;
  border: none;
  border-radius: 0;
}

code {
  padding: 2px 2px;
  color: #E71D36;
  background-color: #f5f5f5;
   
  border-radius: 4px;
  font-size: .7em;
  font-family: monospace;
}



blockquote,
.blockquote {
  padding: 10px 20px;
  margin: 0 0 20px;
  font-size: 1em;
  border-left: 5px solid #6c757d;
}

</style>

</head>


<body>
  <nav class="custom-navbar">
  <div class="container">
    
    <a href="/">notsoformal</a>
    
  </div>
</nav>
  
  <div class="container">
    <article>
      <h1>RFM Model Timelapse</h1>
<p>
  <small class="text-secondary">
  
  
  May 19, 2019
  </small>
  

<small><a href="https://notsoformal.xyz/tags/gganimate">#gganimate</a></small>


<small><a href="https://notsoformal.xyz/tags/ggplot2">#ggplot2</a></small>


</p>



<p>A simple exercise of plotting RFM (recency, frequency, monetary) model and using <code>gganimate</code> to add a cherry on top.</p>
<p>Dataset:
<em>Dr Daqing Chen, Director: Public Analytics group.
chend ‘@’ lsbu.ac.uk, School of Engineering,
London South Bank University, London SE1 0AA, UK.</em></p>
<pre class="r"><code>httr::GET(&quot;https://query.data.world/s/eibmlnrvn7hzil7adpfqceeity3im6&quot;, write_disk(tf &lt;- tempfile(fileext = &quot;.xlsx&quot;)))</code></pre>
<pre><code>## Response [https://download.data.world/file_download/uci/online-retail/Onlinex?auth=eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJwcm9kLXVzZXItY2xpZW50OnRtYXMtamMiLCJpc3MiOiJhZ2VudDp0bWFzLWpjOjoyZDJkOGFjYy0yMDAwLTQ0NWQtOWVlZS02YTZlNDQ5MzI4MzMiLCJpYXQiOjE1NTc5NzQ0NTksInJvbGUiOlsidXNlciIsInVzZXJfYXBpX2FkbWluIiwidXNlcl9hcGlfcmVhZCIsInVzZXJfYXBpX3dyaXRlIl0sImdlbmVyYWwtcHVycG9zZSI6ZmFsc2UsInVybCI6IjJlZWY3ZTEwMzllNmU5NjRiNTdlZDdhNTJiNzYyNmVkNzM0NjM4M2YifQ.TH1yJ7mMLNo8jDJs_EAiuwEh4JJlQELaMJ_aJVVEKgyYYdiy-h_N56sgGbm1p8y1BIBaI3iFNM7yFwiGLE9Qpg]
##   Date: 2020-02-08 13:58
##   Status: 200
##   Content-Type: text/html
##   Size: 23.7 MB
## &lt;ON DISK&gt;  /var/folders/xj/wctktk112yz7y6skyk6z40jr0000gp/T//RtmpWPTUw0/file7a177c67c6e2.xlsx</code></pre>
<pre class="r"><code>raw &lt;- read_excel(tf) %&gt;% clean_names()</code></pre>
<pre class="r"><code># select important features
dat &lt;- raw %&gt;% 
    select(customer_id, invoice_no, invoice_date, unit_price, quantity) %&gt;% 
    mutate(total_paid = unit_price * quantity, 
           invoice_date = lubridate::as_date(invoice_date)) %&gt;% 
    rename(date = invoice_date, invoice = invoice_no)

# count in recency, frequency, and monetary
d &lt;- max(dat$date)

dat &lt;- dat %&gt;% 
    group_by(customer_id) %&gt;% 
    summarise(rec = time_length(interval(d, max(date)), &quot;days&quot;), 
              freq = n_distinct(invoice), 
              monet = sum(total_paid)) %&gt;% 
    mutate(rec = abs(rec), monet = monet / freq) %&gt;% 
    # only keep positive amount
    filter(monet &gt;= 0)


# EDA ------------------------------------------------------------

dat %&gt;% 
    gather(var, val, -customer_id) %&gt;% 
    group_by(var) %&gt;% 
    # remove outliers 
    filter(val &lt;= quantile(val, 0.99)) %&gt;% 
    ggplot(aes(val)) + 
    geom_histogram(aes(y = ..density.., fill = var), bins = 60) + 
    facet_wrap(~ var, scales = &quot;free&quot;, ncol = 1) +
    labs(x = &quot;&quot;, y = &quot;&quot;, fill = &quot;&quot;)</code></pre>
<p><img src="/post/2019-05-19-rfm-model-timelapse_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="r"><code># binning
df &lt;- dat %&gt;% 
    filter_at(.vars = c(&quot;rec&quot;, &quot;freq&quot;, &quot;monet&quot;), all_vars(. &lt;= quantile(., 0.99))) %&gt;% 
    mutate(freq_bin = Hmisc::cut2(freq, g = 6),
           rec_bin = Hmisc::cut2(rec, g = 3),
           monet_bin = Hmisc::cut2(monet, g = 9))

# facet histogram
df %&gt;% 
    ggplot(aes(monet_bin)) + 
    geom_bar(stat = &quot;count&quot;, width = .3, fill = &quot;dodgerblue&quot;) + 
    facet_grid(rec_bin ~ freq_bin) + 
    theme(axis.text.x = element_text(angle = 90))  + 
    labs(x = &quot;&quot;, y = &quot;&quot;)</code></pre>
<p><img src="/post/2019-05-19-rfm-model-timelapse_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<pre class="r"><code># heatmap
df %&gt;% 
    # collapse data frame to add &#39;m&#39;
    group_by(freq_bin, rec_bin) %&gt;% 
    summarise(mean = mean(monet)) %&gt;% 
    ungroup() %&gt;% 
    mutate(ind = 1:n()) %&gt;% 
    ggplot(aes(freq_bin, fct_rev(rec_bin), fill = mean)) +
    geom_raster(interpolate = TRUE) +
    scale_x_discrete(position = &quot;top&quot;) +
    #scale_fill_brewer(type = &quot;seq&quot;) + 
    scale_fill_viridis_c() +
    labs(x = &#39;Frequency&#39;, y = &quot;Recency&quot;, fill = &quot;Monetary&quot;)</code></pre>
<p><img src="/post/2019-05-19-rfm-model-timelapse_files/figure-html/unnamed-chunk-4-2.png" width="672" /></p>
<p>The moving RFM model by week.</p>
<pre class="r"><code># make series of time points
ds &lt;- seq.Date(as.Date(&quot;2011-01-01&quot;), as.Date(&quot;2011-12-01&quot;), by = &quot;week&quot;)

# make series of rfm snapshots
long_dfs &lt;- purrr::map(ds, ~ {
    raw %&gt;% 
        mutate(total_paid = unit_price * quantity, 
               invoice_date = lubridate::as_date(invoice_date)) %&gt;% 
        filter(invoice_date &lt;= .x) %&gt;% 
        group_by(customer_id) %&gt;% 
        summarise(rec = time_length(interval(.x, max(invoice_date)), &quot;days&quot;), 
                  freq = n_distinct(invoice_no), 
                  monet = sum(total_paid)) %&gt;% 
        mutate(rec = abs(rec), monet = monet / freq) %&gt;% 
        # only keep positive amount
        filter(monet &gt;= 0) %&gt;% 
        filter_at(.vars = c(&quot;rec&quot;, &quot;freq&quot;, &quot;monet&quot;), all_vars(. &lt;= quantile(., 0.99))) %&gt;% 
        # must be fixed interval 
        mutate(freq_bin = Hmisc::cut2(freq, cuts = c(1, 2, 3, 4, 5, 8, 99)),
           rec_bin = Hmisc::cut2(rec, cuts = c(0, 25, 87, 360)),
           monet_bin = Hmisc::cut2(monet, cuts = c(0, 108, 146, 180, 215, 262, 318, 9999)))
})

# tidy up long data frame above
long_dfs &lt;- long_dfs %&gt;% 
    bind_rows(.id = &quot;m&quot;) %&gt;% 
    mutate(m = as.numeric(m)) %&gt;% 
    mutate_at(vars(contains(&quot;bin&quot;)), as.factor) %&gt;%
    # collapse data frame to add &#39;m&#39;
    group_by(m, freq_bin, rec_bin) %&gt;% 
    summarise(mean = mean(monet))
    
# make animation
anim &lt;- long_dfs %&gt;%
    ggplot(aes(freq_bin, fct_rev(rec_bin), fill = mean)) +
    geom_raster(interpolate = TRUE) +
    scale_x_discrete(position = &quot;top&quot;) +
    #scale_fill_brewer(type = &quot;seq&quot;) +
    scale_fill_viridis_c() +
    # make animation here ----
    labs(x = &#39;Frequency&#39;, y = &quot;Recency&quot;, fill = &quot;Monetary&quot;, 
         title = &quot;Week {closest_state}&quot;) +
    transition_states(m, transition_length = 1, state_length = 5) +
    ease_aes(&#39;linear&#39;)
#anim_save(animation = anim, filename = &quot;moving_rfm.gif&quot;, path = &quot;content/etc/&quot;)</code></pre>
<p><img src="/etc/moving_rfm.gif" /></p>

    </article>
  </div>

  
  
  

  

  
</body>

</html>
